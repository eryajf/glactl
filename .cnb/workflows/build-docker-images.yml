main:
  push:
    - runner:
        cpus: 8
      services:
        - docker
        - git-clone-yyds
      stages:
        - name: 📦 推送镜像
          image: docker.cnb.cool/znb/images/debian:all
          script: |
            cat /root/.docker/config.json
            make gox-linux
            docker login -u ${CNB_TOKEN_USER_NAME} -p "${CNB_TOKEN}" ${CNB_DOCKER_REGISTRY}
            docker run -d --name buildkitd \
              --security-opt seccomp=unconfined \
              --security-opt apparmor=unconfined \
              --security-opt systempaths=unconfined \
              moby/buildkit:rootless
            docker buildx create --use \
              --name mybuilder \
              --driver remote docker-container://buildkitd
            docker buildx build -t ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE} --platform=linux/arm64,linux/amd64 . --push